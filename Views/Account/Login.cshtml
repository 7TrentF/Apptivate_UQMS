@model Apptivate_UQMS_WebApp.Models.Account.LoginViewModel
@*
 Use the MinimalLayout for Register.cshtml and Login.cshtml
*@



@{
    Layout = "~/Views/Shared/MinimalLayout.cshtml";
}





<link href="~/css/Login.css" rel="stylesheet" type="text/css" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">



<body class="body">

    <div class="login-container">
        <h1>Welcome</h1>

        <form asp-action="Login" method="post">
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" class="form-control" id="email" name="email" placeholder="Enter Email Address" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" class="form-control" id="password" name="password" placeholder="Enter Password" required>
                <span class="toggle-password">👁️</span>
            </div>
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="rememberMe" name="rememberMe">
                <label class="form-check-label" for="rememberMe">Remember me on this computer</label>
            </div>
            <button type="submit" class="btn">LOG IN</button>
            <div class="form-footer">
                <a href="#">Forgot Password?</a><br>
                <span>Don't have an account? <a href="/Account/SelectRole">Register</a></span>
            </div>
            <div class="divider">
                <span>OR</span>
            </div>
            <div id="googleSignIn" class="google-btn">
                <button type="button" class="btn btn-google">
                    <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google logo">
                    Sign in with Google
                </button>
            </div>
        </form>
    </div>

    <script src="~/js/login.js"></script>
    @section Scripts {
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
        <script>
            console.log('Starting Firebase initialization...');
            const firebaseConfig = {
                apiKey: "AIzaSyDXB0dEozyPQdXzlGyQFP1elMObEksarR0",
                authDomain: "uqms-a3d87.firebaseapp.com",
                projectId: "uqms-a3d87",
                storageBucket: "uqms-a3d87.appspot.com",
                messagingSenderId: "728626322581",
                appId: "1:728626322581:web:a5809843d30cf49aef4f9c",
                measurementId: "G-ZGLBS2PFY8"
            };

            try {
                const app = firebase.initializeApp(firebaseConfig);
                console.log('Firebase initialized successfully');

                function initializeGoogleSignIn() {
                    console.log('Setting up Google Sign-In...');
                    const googleBtn = document.querySelector('.btn-google');

                    if (!googleBtn) {
                        console.error('Google sign-in button not found');
                        return;
                    }

                    googleBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        console.log('Google button clicked');

                        try {
                            const provider = new firebase.auth.GoogleAuthProvider();
                            const result = await firebase.auth().signInWithPopup(provider);
                            const idToken = await result.user.getIdToken();

                            const response = await fetch('/Account/GoogleLogin', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json'
                                },
                                body: JSON.stringify({ idToken: idToken })
                            });

                            const contentType = response.headers.get('content-type');
                            if (!contentType || !contentType.includes('application/json')) {
                                throw new Error('Received non-JSON response from server');
                            }

                            const data = await response.json();
                            console.log('Backend response:', data);

                            if (data.success) {
                                window.location.href = data.redirectUrl;
                            } else {
                                if (data.requiresRegistration) {
                                    alert('This email is not registered. Please register your account first with your university details.');
                                    window.location.href = '/Account/SelectRole';
                                } else {
                                    alert('Failed to login with Google: ' + data.error);
                                }
                            }
                        } catch (error) {
                            console.error('Google sign-in error:', error);
                            alert('Failed to login with Google: ' + error.message);
                        }
                    });
                }

                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initializeGoogleSignIn);
                } else {
                    initializeGoogleSignIn();
                }

            } catch (error) {
                console.error('Firebase initialization error:', error);
            }
        </script>
    }
</body>
